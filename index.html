<!DOCTYPE html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="apple-touch-icon" href="gachatt.png"/>
<meta property="og:image" content="gachatt.png"/>
<meta name="format-detection" content="telephone=no"/>
<title>福井県施設ダッシュボード</title>
<script type='module'>

import util from './util.mjs'

const parseMinutesJP = function(s) {
  s = util.toHalf(s)
  let h = 0
  let m = 0
  let num = s.match(/(午前|午後)(\d+)時(\d+)分/)
  if (num) {
    h = parseInt(num[2]) + (num[1] == '午後' ? 12 : 0)
    m = parseInt(num[3])
  }
  num = s.match(/(午前|午後)(\d+)時/)
  if (num) {
    h = parseInt(num[2]) + (num[1] == '午後' ? 12 : 0)
  } else {
    throw 'error ' + s
  }
  return h * 60 + m
}
const getMinutesNow = function(t) {
  if (!t)
    t = new Date()
  return t.getHours() * 60 + t.getMinutes()
  //return 9 * 60 + 30
  //return 17 * 60 + 1
  //return 18 * 60 + 0
}
const isOpeningMinutes = function(nowt, duration) {
  const s = duration.split('〜')
  const st = parseMinutesJP(s[0])
  const ed = parseMinutesJP(s[1])
  const now = getMinutesNow(nowt)
  return now >= st && now <= ed
}
/*
console.log(parseMinutesJP('午前９時30分'))
console.log(parseMinutesJP('午前10時'))
console.log(parseMinutesJP('午前時'))
*/
const parseDaysJP = function(s) {
  s = util.toHalf(s)
  let num = s.match(/(\d+)月(\d+)日/)
  if (num) {
    let m = parseInt(num[1])
    let d = parseInt(num[2])
    return m * 100 + d
  } else {
    console.log('error', s)
    throw 'error ' + s
  }
}
const getDaysNow = function(t) {
  if (!t)
    t = new Date()
  return (t.getMonth() + 1) * 100 + t.getDate()
  //return 921
  //return 1229
  //return 104 // 1/4
  //return 103 // 1/3
  //return 428
  //return 408
}
const isDaysMatch = function(holiday, rest, now) {
  rest = util.toHalf(rest)
  const d = new Date()
  d.setMonth(Math.floor(now / 100) - 1)
  d.setDate(now % 100)
  const day = d.getDay()
  const ymd = util.formatYMD(d)
  //console.log(rest, ymd)
  const WEEKS = '日月火水木金土'
  let m = rest.match(/^(毎週)?([日月火水木金土])曜日/)
  if (m) {
    const week = WEEKS.indexOf(m[2])
    //console.log('week', week, m[2], day)
    return week == day
  }
  const NUMS = '一二三四五12345'
  m = rest.match(/^第([一二三四五12345])・?第([一二三四五12345])([日月火水木金土])曜日/)
  if (m) {
    const week = WEEKS.indexOf(m[3])
    if (week != day)
      return false
    for (let i = 1; i <= 2; i++) {
      const nth = NUMS.indexOf(m[i]) % 5
      const date = d.getDate()
      //console.log(nth, date)
      if (Math.floor(date / 7) == nth)
        return true
    }
    return false
  }
  m = rest.match(/^第([一二三四五12345])([日月火水木金土])曜日/)
  if (m) {
    const week = WEEKS.indexOf(m[2])
    if (week != day)
      return false
    const nth = NUMS.indexOf(m[1]) % 5
    const date = d.getDate()
    //console.log(nth, date)
    return Math.floor(date / 7) == nth
  }
  if (rest == '祝日') {
    for (const h of holiday) {
      if (h.date == ymd)
        return true
    }
    return false
  }
  if (rest == '休日') {
    if (day == 0 || day == 6) // 土日
      return true
    for (const h of holiday) { // 祝日
      if (h.date == ymd)
        return true
    }
    return false
  }
  if (rest == '休日の翌日') {
    // まずその日が休日の場合は除く
    if (day == 0 || day == 6) // 土日
      return false
    for (const h of holiday) { // 祝日
      if (h.date == ymd)
        return false
    }
    // 翌日は休日は？
    const d2 = new Date(d.getTime() - (1000 * 60 * 60 * 24))
    const day2 = d2.getDay()
    const ymd2 = util.formatYMD(d2)
    if (day2 == 0 || day2 == 6) // 土日
      return true
    for (const h of holiday) { // 祝日
      if (h.date == ymd2)
        return true
    }
    return false
  }
  if (rest == '臨時休館日') {
    return false
  }
  console.log('error ', rest)
  //throw rest
  return false
}
const checkDays = function(during, now) {
  const n = during.indexOf('〜')
  if (n < 0) {
    return parseDaysJP(during) == now
  }
  const s = during.split('〜')
  const st = parseDaysJP(s[0])
  const ed = parseDaysJP(s[1])
  if (st > ed) {
    return now >= st || now <= ed
  }
  return now >= st && now <= ed
}
const isOpeningDays = function(nowt, holiday, restday, yearend, other) {
  const now = getDaysNow(nowt)
  if (other.length > 0) {
    const others = other.split('、')
    for (const o of others) {
      if (checkDays(o, now))
        return false
    }
  }
  if (yearend.length > 0) {
    if (checkDays(yearend, now))
      return false
  }
  if (restday) {
    const ss = restday.split('、')
    for (const r of ss) {
      const res = isDaysMatch(holiday, r, now)
      //console.log(r, now, res)
      if (res)
        return false
    }
  }
  return true
}

const main = async function() {
  const url_holiday = 'data/holiday_jp.csv'
  const holiday = await util.fetchCSVtoJSON(url_holiday)
  //console.log(holiday)

  const url = 'data/fukui.csv'
  const data = await util.fetchCSVtoJSON(url)
  //console.log(data)

  const cr = tag => document.createElement(tag)
  const s = []
  const tbl = cr('table')
  const head = [ '開館状況', '混雑状況', '施設名', '休館日', '年末年始', '臨時休館日', '開館時間' ]
  const tr = cr('tr')
  for (const h of head) {
    const th = cr('th')
    th.textContent = h
    tr.appendChild(th)
  }
  tbl.appendChild(tr)
  const now = new Date()
  for (const d of data) {
    const tr = cr('tr')

    let td = cr('td')
    //const n = util.rnd(2)
    //console.log(d.施設名)
    const n = isOpeningDays(now, holiday, d['休館日'], d['年末年始'], d['臨時休館日']) && isOpeningMinutes(now, d['開館時間'])
    td.setOpening = function(n) {
      this.textContent = n ? '開館中' : '閉館中'
      this.style.backgroundColor = n ? '#f88' : '#ccc'
    }
    td.setOpening(n)
    d.opening = td
    tr.appendChild(td)

    td = cr('td')
    const flg = d['混雑状況'] == 1
    td.textContent = n ? (flg ? '混雑' : '空き') : "-"
    td.style.backgroundColor = flg ? '#f88' : '#ccc'
    tr.appendChild(td)
    d.status = td

    for (let i = 2; i < head.length; i++) {
      const name = head[i]
      td = cr('td')
      td.textContent = d[name]
      tr.appendChild(td)
    }
    tbl.appendChild(tr)
  }
  mainc.appendChild(tbl)
  
  seldt.value = util.formatYMDHMS(new Date())
  const show = function(now) {
    console.log(now)
    for (const d of data) {
      const n = isOpeningDays(now, holiday, d['休館日'], d['年末年始'], d['臨時休館日']) && isOpeningMinutes(now, d['開館時間'])
      console.log(n)
      d.opening.setOpening(n)
      d.status.textContent = '-'
      d.status.style.backgroundColor = '#ccc'
    }
  }
  show(now)
  seldt.onchange = function() {
    show(new Date(seldt.value))
  }
}
window.onload = main


</script>
<style>
body {
	font-family: sans-serif;
	margin: 0;
  word-wrap: break-word;
  --main-color: rgb(78, 145, 66);
  text-align: center;
}
h1 {
	margin: 0;
	padding: .0em;
	background-color: var(--main-color);
	color: white;
	font-size: 8vw;
	text-align: center;
}
h2 {
  font-size: 3vw;
}
.subtitle {
	text-align: center;
	margin: 0;
	padding: .3em;
	background-color: var(--main-color);
	color: white;
	font-size: 3vw;
}
#mainc {
  font-size: 1.7vw;
  text-align: left;
  margin: 1vw;
  text-align: center;
}
#mainc table {
  border-collapse: collapse;
  border: 2px solid #aaa;
  display: inline-block;
}
td, #mainc th {
  border: 2px solid #aaa;
  text-align: left;
  padding: .1vw .6vw;
}
#seldt {
  font-family: sans-serif;
  font-size: 2vw;
}
#debug {
  border: 1px solid black;
  margin: 1em;
  padding: 0.5em;
  font-size: 70%;
}
#src {
	margin: .5em;
}
#materials a {
  margin-left: 1em;
}
a {
	color: gray !important;
}
</style>
</head>
<body>

<h1 id=title>施設状況</h1><div class=subtitle>福井県施設ダッシュボード</div>
<div id="mainc"></div>
<input id='seldt' type='datetime-local'>

<div id="link">

<div id="src">
  <!--
DATA: CC BY 「<a href=https://fukuno.jig.jp/2820>時間割ガチャ - 教材オープンデータあつめ始めました</a>」 <a href=data/funs.csv>CSV</a> / <a href=data/funs.json>JSON</a><br>
Educatino Materials: <span id='materials'></span><br>
APP：CC BY <a href='https://fukuno.jig.jp/2820'>fukuno.jig.jp</a> <a href=https://github.com/code4fukui/timetable/>src on GitHub</a><br>
  -->
</div>
<img id=qrcode><script>addEventListener("load", () => qrcode.src = "https://chart.apis.google.com/chart?chs=140x140&cht=qr&chl=" + encodeURIComponent(document.location))</script><br>

</div>

</body>
</html>